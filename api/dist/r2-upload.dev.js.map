{"version":3,"sources":["r2-upload.js"],"names":["R2","S3Client","region","endpoint","process","env","CLOUDFLARE_ACCOUNT_ID","credentials","accessKeyId","R2_ACCESS_KEY_ID","secretAccessKey","R2_SECRET_ACCESS_KEY","BUCKET_NAME","generatePresignedUrl","req","res","query","filename","contentType","status","json","error","timestamp","Date","now","randomStr","Math","random","toString","substring","extension","split","pop","key","command","PutObjectCommand","Bucket","Key","ContentType","expiresIn","presignedUrl","url","publicUrl","console","setupR2Cors","PutBucketCorsCommand","corsConfig","CORSConfiguration","CORSRules","AllowedHeaders","AllowedMethods","AllowedOrigins","ExposeHeaders","MaxAgeSeconds","send","log"],"mappings":"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","sourcesContent":["// backend/api/r2-presigned-url.js\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\n\r\n// Initialize R2 Client\r\nconst R2 = new S3Client({\r\n  region: 'auto',\r\n  endpoint: `https://${process.env.CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com`,\r\n  credentials: {\r\n    accessKeyId: process.env.R2_ACCESS_KEY_ID,\r\n    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,\r\n  },\r\n});\r\n\r\nconst BUCKET_NAME = 'images'; // Your bucket name\r\n\r\n// Express route handler (or adapt to your framework)\r\nexport async function generatePresignedUrl(req, res) {\r\n  try {\r\n    const { filename, contentType } = req.query;\r\n    \r\n    if (!filename || !contentType) {\r\n      return res.status(400).json({ error: 'filename and contentType required' });\r\n    }\r\n\r\n    // Generate unique filename with timestamp\r\n    const timestamp = Date.now();\r\n    const randomStr = Math.random().toString(36).substring(7);\r\n    const extension = filename.split('.').pop();\r\n    const key = `posts/${timestamp}-${randomStr}.${extension}`;\r\n\r\n    // Create presigned URL\r\n    const command = new PutObjectCommand({\r\n      Bucket: BUCKET_NAME,\r\n      Key: key,\r\n      ContentType: contentType,\r\n    });\r\n\r\n    const presignedUrl = await getSignedUrl(R2, command, {\r\n      expiresIn: 3600, // URL expires in 1 hour\r\n    });\r\n\r\n    // Return presigned URL and key\r\n    res.json({\r\n      url: presignedUrl,\r\n      key: key,\r\n      publicUrl: `https://pub-yourhash.r2.dev/${key}` // Replace with your public R2 domain\r\n    });\r\n  } catch (error) {\r\n    console.error('Error generating presigned URL:', error);\r\n    res.status(500).json({ error: 'Failed to generate upload URL' });\r\n  }\r\n}\r\n\r\n// Setup CORS for your R2 bucket (run once)\r\n// You need to do this from your backend or using AWS CLI\r\nexport async function setupR2Cors() {\r\n  const { PutBucketCorsCommand } = await import('@aws-sdk/client-s3');\r\n  \r\n  const corsConfig = {\r\n    Bucket: BUCKET_NAME,\r\n    CORSConfiguration: {\r\n      CORSRules: [\r\n        {\r\n          AllowedHeaders: ['content-type', 'x-amz-*'],\r\n          AllowedMethods: ['PUT', 'GET'],\r\n          AllowedOrigins: ['http://localhost:8100', 'https://yourdomain.com'], // Add your domains\r\n          ExposeHeaders: [],\r\n          MaxAgeSeconds: 3600,\r\n        },\r\n      ],\r\n    },\r\n  };\r\n\r\n  const command = new PutBucketCorsCommand(corsConfig);\r\n  await R2.send(command);\r\n  console.log('CORS configured successfully');\r\n}\r\n\r\n"],"file":"r2-upload.dev.js"}