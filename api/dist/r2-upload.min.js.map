{"version":3,"sources":["r2-upload.js"],"names":["_clientS","require","_s3RequestPresigner","R2","S3Client","region","endpoint","concat","process","env","CLOUDFLARE_ACCOUNT_ID","credentials","accessKeyId","R2_ACCESS_KEY_ID","secretAccessKey","R2_SECRET_ACCESS_KEY","BUCKET_NAME","generatePresignedUrl","req","res","_req$query","filename","contentType","timestamp","randomStr","extension","key","command","presignedUrl","regeneratorRuntime","async","_context","prev","next","query","abrupt","status","json","error","Date","now","Math","random","toString","substring","split","pop","PutObjectCommand","Bucket","Key","ContentType","awrap","expiresIn","sent","url","t0","console","stop","setupR2Cors","PutBucketCorsCommand","CORSConfiguration","CORSRules","AllowedHeaders","AllowedMethods","AllowedOrigins","ExposeHeaders","send","log"],"mappings":"sJACA,IAAAA,SAAAC,QAAA,sBACAC,oBAAAD,QAAA,i4BAGA,IAAME,GAAK,IAAIC,SAAAA,SAAS,CACtBC,OAAQ,OACRC,SAAQ,WAAAC,OAAaC,QAAQC,IAAIC,sBAAzB,6BANVC,YAAA,CAQIC,YAAaJ,QAAQC,IAAII,iBAP7BC,gBAAAN,QAAAC,IAAAM,wBAYMC,YAAc,SAGb,SAAeC,qBAAqBC,EAAKC,GAAzC,IAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA,OAAAC,mBAAAC,MAAA,SAAAC,GAAA,OAAA,OAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,GAAAF,EAAAC,KAAA,EAAAZ,EAZiBF,EAAAgB,MAAbb,EAYJD,EAZIC,SAAIjB,EAYRgB,EAZQhB,YAEbE,GAAQgB,EAUH,CAAAS,EAAAE,KAAA,EAAA,MAAA,OAAAF,EAAAI,OAAA,SATMhB,EAAEiB,OAAA,KAAAC,KAAA,CAAAC,MAAA,uCASR,KAAA,EAAA,OAZPf,EAAAgB,KAAAC,MASMxB,EAAcyB,KAaOC,SAbGC,SAAA,IAAAC,UAAA,GAE9BnB,EAAAJ,EAAAwB,MAAA,KAAAC,MAaUpB,EAZH,SAAAnB,OAYkBgB,EAZlB,KAAAhB,OAY+BiB,EAZ/B,KAAAjB,OAY4CkB,GAGzCE,EAAU,IAAIoB,SAAAA,iBAAiB,CAflCC,OAAAhC,YAAAiC,IAAAvB,EAAAwB,YAAA5B,IAAAS,EAAAE,KAAA,GAAAJ,mBAAAsB,OAEmCjB,EAAAA,oBAAAA,cAFnC/B,GAAAwB,EAEKN,CAoBN+B,UAAW,QAtBV,KAAA,GAAAxB,EAAAG,EAAAsB,KAAAlC,EAAAkB,KAAA,CA2BDiB,IAAK1B,EA3BJF,IAAAA,EAK6BY,UAAAA,+BAAAA,OAAOZ,KALpCK,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAwB,GAAAxB,EAAA,MAAA,GAAAyB,QAAAlB,MAAA,kCAAAP,EAAAwB,IAQHpC,EAAAiB,OAAA,KAAAC,KAAA,CAAAC,MAAA,kCARG,KAAA,GAAA,IAAA,MAAA,OAAAP,EAAA0B,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,MAeG9B,SAAU+B,cAAV/B,IAAAA,EAAAA,EAAAA,EAAAA,OAAAA,mBAAAA,MAAAA,SAAAA,GAAAA,OAAAA,OAAAA,EAAAA,KAAAA,EAAAA,MAAAA,KAAAA,EAAAA,OAAAA,EAAAA,KAAAA,EAAAA,mBAAAA,MAAAA,QAAAA,UAAAA,KAAAA,WAAAA,OAAAA,wBAAAA,QAA+B,0BAA/BA,KAAAA,EAAAA,OAAAA,EAAAA,EAAAA,KACJqB,EADIrB,EACJqB,qBAyCErB,EAAU,IAAIgC,EAvChBT,CAHmCF,OAflChC,YAAA4C,kBAAA,CAAAC,UAAA,CAsBDT,CAyBIU,eAAgB,CAAC,eAAgB,WA1BcC,eArBlD,CAAA,MAAA,OAiDGC,eAAgB,CAAC,wBAAyB,0BAjD7CC,cAAA,GAqBGrC,cArBH,UAeGD,EAAAA,KAAAA,EAAAA,mBAAAA,MAWGxB,GAAT+D,KAAAvC,IAXMA,KAAAA,EAfH6B,QAAAW,IAAA,gCAeGxC,KAAAA,EAAAA,IAAAA,MAAAA,OAAAA,EAAAA","file":"r2-upload.min.js","sourcesContent":["// backend/api/r2-presigned-url.js\r\nimport { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';\r\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner';\r\n\r\n// Initialize R2 Client\r\nconst R2 = new S3Client({\r\n  region: 'auto',\r\n  endpoint: `https://${process.env.CLOUDFLARE_ACCOUNT_ID}.r2.cloudflarestorage.com`,\r\n  credentials: {\r\n    accessKeyId: process.env.R2_ACCESS_KEY_ID,\r\n    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY,\r\n  },\r\n});\r\n\r\nconst BUCKET_NAME = 'images'; // Your bucket name\r\n\r\n// Express route handler (or adapt to your framework)\r\nexport async function generatePresignedUrl(req, res) {\r\n  try {\r\n    const { filename, contentType } = req.query;\r\n    \r\n    if (!filename || !contentType) {\r\n      return res.status(400).json({ error: 'filename and contentType required' });\r\n    }\r\n\r\n    // Generate unique filename with timestamp\r\n    const timestamp = Date.now();\r\n    const randomStr = Math.random().toString(36).substring(7);\r\n    const extension = filename.split('.').pop();\r\n    const key = `posts/${timestamp}-${randomStr}.${extension}`;\r\n\r\n    // Create presigned URL\r\n    const command = new PutObjectCommand({\r\n      Bucket: BUCKET_NAME,\r\n      Key: key,\r\n      ContentType: contentType,\r\n    });\r\n\r\n    const presignedUrl = await getSignedUrl(R2, command, {\r\n      expiresIn: 3600, // URL expires in 1 hour\r\n    });\r\n\r\n    // Return presigned URL and key\r\n    res.json({\r\n      url: presignedUrl,\r\n      key: key,\r\n      publicUrl: `https://pub-yourhash.r2.dev/${key}` // Replace with your public R2 domain\r\n    });\r\n  } catch (error) {\r\n    console.error('Error generating presigned URL:', error);\r\n    res.status(500).json({ error: 'Failed to generate upload URL' });\r\n  }\r\n}\r\n\r\n// Setup CORS for your R2 bucket (run once)\r\n// You need to do this from your backend or using AWS CLI\r\nexport async function setupR2Cors() {\r\n  const { PutBucketCorsCommand } = await import('@aws-sdk/client-s3');\r\n  \r\n  const corsConfig = {\r\n    Bucket: BUCKET_NAME,\r\n    CORSConfiguration: {\r\n      CORSRules: [\r\n        {\r\n          AllowedHeaders: ['content-type', 'x-amz-*'],\r\n          AllowedMethods: ['PUT', 'GET'],\r\n          AllowedOrigins: ['http://localhost:8100', 'https://yourdomain.com'], // Add your domains\r\n          ExposeHeaders: [],\r\n          MaxAgeSeconds: 3600,\r\n        },\r\n      ],\r\n    },\r\n  };\r\n\r\n  const command = new PutBucketCorsCommand(corsConfig);\r\n  await R2.send(command);\r\n  console.log('CORS configured successfully');\r\n}\r\n\r\n"]}