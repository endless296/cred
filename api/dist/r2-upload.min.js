"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.generatePresignedUrl=generatePresignedUrl,exports.setupR2Cors=setupR2Cors;var _clientS=require("@aws-sdk/client-s3"),_s3RequestPresigner=require("@aws-sdk/s3-request-presigner");function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _getRequireWildcardCache(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return _getRequireWildcardCache=function(){return e},e}function _interopRequireWildcard(e){if(e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache();if(r&&r.has(e))return r.get(e);var t={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var s=n?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(t,o,s):t[o]=e[o]}return t.default=e,r&&r.set(e,t),t}var R2=new _clientS.S3Client({region:"auto",endpoint:"https://".concat(process.env.CLOUDFLARE_ACCOUNT_ID,".r2.cloudflarestorage.com"),credentials:{accessKeyId:process.env.R2_ACCESS_KEY_ID,secretAccessKey:process.env.R2_SECRET_ACCESS_KEY}}),BUCKET_NAME="images";function generatePresignedUrl(r,t){var n,o,s,a,c,u,i,l,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.query,o=n.filename,s=n.contentType,o&&s){e.next=4;break}return e.abrupt("return",t.status(400).json({error:"filename and contentType required"}));case 4:return a=Date.now(),c=Math.random().toString(36).substring(7),u=o.split(".").pop(),i="posts/".concat(a,"-").concat(c,".").concat(u),l=new _clientS.PutObjectCommand({Bucket:BUCKET_NAME,Key:i,ContentType:s}),e.next=11,regeneratorRuntime.awrap((0,_s3RequestPresigner.getSignedUrl)(R2,l,{expiresIn:3600}));case 11:p=e.sent,t.json({url:p,key:i,publicUrl:"https://pub-yourhash.r2.dev/".concat(i)}),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("Error generating presigned URL:",e.t0),t.status(500).json({error:"Failed to generate upload URL"});case 19:case"end":return e.stop()}},null,null,[[0,15]])}function setupR2Cors(){var r,t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(Promise.resolve().then(function(){return _interopRequireWildcard(require("@aws-sdk/client-s3"))}));case 2:return r=e.sent,t=r.PutBucketCorsCommand,n=new t({Bucket:BUCKET_NAME,CORSConfiguration:{CORSRules:[{AllowedHeaders:["content-type","x-amz-*"],AllowedMethods:["PUT","GET"],AllowedOrigins:["http://localhost:8100","https://yourdomain.com"],ExposeHeaders:[],MaxAgeSeconds:3600}]}}),e.next=8,regeneratorRuntime.awrap(R2.send(n));case 8:console.log("CORS configured successfully");case 9:case"end":return e.stop()}})}
//# sourceMappingURL=r2-upload.min.js.map
